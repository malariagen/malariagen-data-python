name: tagged_docs
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
jobs:
  tagged_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # Remove the prefix "refs/*/" from $GITHUB_REF to get the tag
      # Add var assignment to the $GITHUB_ENV file, so VERSION_TAG is available in later steps
      - name: Set VERSION_TAG env var âš™ï¸
        run: echo "VERSION_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Eyeball VERSION_TAG env var ğŸ‘€
        run: |
          echo "$VERSION_TAG"
          echo ${{ env.VERSION_TAG }}

      - name: Check out VERSION_TAG ğŸ›’
        uses: actions/checkout@v3
        with:
          ref: ${{ env.VERSION_TAG }}

      - name: Set up Python ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Poetry ğŸ“œ
        run: pip install poetry

      - name: Eyeball native environment ğŸ‘€
        run: python --version ; pip --version ; poetry --version ; pwd ; ls -la

      - name: Install package dependencies ğŸ“œ
        run: poetry install

      - name: Install docs dependencies ğŸ“œ
        run: poetry run pip install -r docs/requirements.txt

      - name: Build HTML ğŸ—ï¸
        run: poetry run sphinx-build -b html docs/source docs/build/html

      - name: Deploy HTML to GitHub Pages ğŸš€
        uses: peaceiris/actions-gh-pages@v3.9.3
        with:
          publish_branch: gh-pages
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/build/html
          destination_dir: ${{ env.VERSION_TAG }}
